<h1 style="text-align: center; ">Node.js는 싱글스레드인가?</h1>
<p style="text-align: right;"> updated 2020.08 </p>

## Node.js는 싱글스레드다?

--- 

&nbsp;흔히들 Node.js는 싱글스레드라 말하지만, 엄밀히 따지면 Node.js 자체는 싱글스레드가 아니다.<br>
정확히 말하면 자바스크립트를 한줄씩 읽어 수행하는 메인스레드인 이벤트 루프가 싱글 스레드일 뿐이다. 즉,

> "Node 런타임에서 구동되는 자바스크립트 코드는 싱글 스레드인 이벤트 루프에 의해서 수행된다."

가 더 올바른 표현일 것이다.

&nbsp;자바스크립트 코드에서 사용한 Node.js API들이 CPU연산과 논리를 수행하는 작업일 경우, 여타 언어들 처럼 LIFO를 충실히 따르면서 V8 엔진의 콜스택에 Push되었다가 Pop되며 수행된다.
하지만, I/O bound(disk, network 에 대한 접근)등의 **비동기 작업에 도달하면 Node.js API는 libuv라는 라이브러리를 호출한뒤 기다리지 않고 콜스택을 Pop 시키며 다음 줄이
실행된다.**

&nbsp;**libuv**는 OS 시스템의 비동기 처리를 한단계 추상화하여 cross-platform 비동기를 구현한 라이브러리로, 이벤트 루프를
포함한다([https://github.com/libuv/libuv/tree/v1.x/src/unix](https://github.com/libuv/libuv/tree/v1.x/src/unix)). <br>
&nbsp;Node.js 의 비동기 API, libuv를 호출하면 Block 상태에 있던 이벤트 루프가 실행되는데, **<u>이벤트 루프는 비동기 작업의 종류에 따라서 libuv 스스로의 스레드 풀(Defualt
4개의 스레드) 혹은 커널의 비동기 API로 하여금 작업을 위임하여 수행한 뒤, 이벤트 큐 쌓인 콜백이 있는지를 검사하여 수행하기를 반복한다.</u>** libuv의 각 스레드는 맡은 작업을 모두 수행하면 작업의
종류에 따라서 콜백함수를 이벤트 큐에 삽입함으로써 추후 이벤트 루프에 의해 수행 될 것을 기대한다.<br>
<br>
&nbsp;즉, 이벤트 루프 자체는 싱글스레드로 동작하여 비동기 메세지를 처리하지만, 실제로 비동기 작업을 수행하는 과정에는 스레드 자원을 사용하는 것이다.

비교하자면, Java 로 짜여진 웹 서버는 요청당 하나의 스레드를 만든다. 만들어진 스레드의 생애주기는 애플리케이션 레벨에서 제어 되어야 한다. 반면, Node.js 는 모든 요청을 단일 스레드로 받는다. 덕분에
애플리케이션 레벨에서는 스레드 자원을 신경 쓸 필요 없이 편한 동시성 구현이 가능하다.

&nbsp;하지만 스레드 자원을 신경쓰지 않는다는 말이 동시성 코드를 사용함에 주의가 필요하지 않다는 말은 아니다. **여러개의 요청이 공유하는 리소스에 접근할 때 특히 주의를 기울여야한다.** <br>
모든 요청이 해당 리소스에 대해서 읽기만 수행하면 괜찮지만, Dirty Read, Unrepeatable Read 등 공유되는 리소스에 대한 어떤 문제든지 나타날 가능성이 있으므로 주의해야한다.
<sub>[나의 관련 경험](/projects/work/여러_요청이_한_리소스에_동시_접근_할_때)</sub>
